<!DOCTYPE html>
<html window-frame="none" window-resizable="'none">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <head>
    <title>convert DICOM to OpenVDB</title>
    <style>
      body {
        vertical-align: middle;
        text-align: center;
      }
    </style>
    InitddsaveDicomFolderPathStr
  </head>
  <body>
    <button id="dicomFolderBtn">Choose Dicom Folder</button>
    <div id="dicomPath">Dicom Path</div>
    <button id="outputFolderBtn">Choose Output Folder</button>
    <div id="outputPath">Output Path</div>
    <button id="convert">Convert It</button>
    <div id="result">Result</div>
    <div id="inputMin">inputMin</div>
    <div id="inputMax">inputMax</div>
    <div id="inputSize">inputSize</div>
    <div id="inputSpacing">inputSpacing</div>
    <div id="outputMin">outputMin</div>
    <div id="outputMax">outputMax</div>
    <div id="outputSize">outputSize</div>
    <div id="outputSpacing">outputSpacing</div>
  </body>
  <script type="text/javascript">
    const thisWindow = Window.this;

    document.ready = function () {
      thisWindow.isResizable = false;
      thisWindow.isMaximizable = false;
      thisWindow.move(200, 200, 900, 432);
    };

    document.getElementById("dicomFolderBtn").onclick = function () {
      let dicomPath = thisWindow.selectFolder({
        mode: "open",
      });

      if (dicomPath) {
        globalThis.dicomPath = decodeURIComponent(dicomPath.replace("file://", ""));
        document.getElementById("dicomPath").innerText = globalThis.dicomPath;
        if (globalThis.outputPath === undefined) {
          const path_arr = globalThis.dicomPath.split("/");
          path_arr.pop();
          globalThis.outputPath = path_arr.join("/");
          document.getElementById("outputPath").innerText =
            globalThis.outputPath;
        }
      }
      document.getElementById("result").innerText = "working......";
      document.getElementById("convert").disabled = true;
      function callback(res) {
        if (res["state"] === 0) {
          const inputMeta = {
            min: res["data"]["input_min"],
            max: res["data"]["input_max"],
            spacing: res["data"]["input_spacing"],
            size: res["data"]["input_size"],
          };

          const outputMeta = {
            min: 0,
            max: -res["data"]["input_min"] + res["data"]["input_max"],
            spacing: [1, 1, 1],
            size: res["data"]["input_size"].map((dim, index) => {
              return dim * res["data"]["input_spacing"][index];
            }),
          };
          globalThis.inputMeta = inputMeta;
          globalThis.outputMeta = outputMeta;

          document.getElementById("inputMin").innerText = inputMeta["min"];
          document.getElementById("inputMax").innerText = inputMeta["max"];
          document.getElementById("inputSize").innerText = inputMeta["size"];
          document.getElementById("inputSpacing").innerText =
            inputMeta["spacing"];
          document.getElementById("outputMin").innerText = outputMeta["min"];
          document.getElementById("outputMax").innerText = outputMeta["max"];
          document.getElementById("outputSize").innerText = outputMeta["size"];
          document.getElementById("outputSpacing").innerText =
            outputMeta["spacing"];
          document.getElementById("result").innerText = "ok";
        } else {
          document.getElementById("result").innerText = res["data"];
        }

        document.getElementById("convert").disabled = false;
      }
      thisWindow.appWindow.getMetaInfo(globalThis.dicomPath, callback);
    };

    document.getElementById("outputFolderBtn").onclick = function () {
      let outputPath = thisWindow.selectFolder({
        mode: "open",
      });

      if (outputPath) {
        globalThis.outputPath = decodeURIComponent(outputPath.replace("file://", ""));
        document.getElementById("outputPath").innerText = globalThis.outputPath;
      }
    };

    document.getElementById("convert").onclick = function () {
      if (
        (globalThis.dicomPath === undefined) |
        (globalThis.outputPath === undefined)
      ) {
        thisWindow.modal(
          <info>
            Dicom or output folder is not defined.
            <br />
            Please choose folder path first.
          </info>
        );
        return false;
      }

      document.getElementById("result").innerText = "working......";
      document.getElementById("convert").disabled = true;
      function callback(res) {
        if (res["state"] === 2) {
          document.getElementById("result").innerText = res["data"];
        } else {
          document.getElementById("convert").disabled = false;
          document.getElementById("result").innerText = res["data"];
        }
      }
      thisWindow.appWindow.convertDICOM(
        globalThis.dicomPath,
        globalThis.outputPath,
        globalThis.outputMeta,
        callback
      );
    };
  </script>
</html>
