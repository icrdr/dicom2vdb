<!DOCTYPE html>
<html
  window-frame="none"
  window-resizable="'none"
  window-icon="icon.ico"
>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <head>
    <title>DICOM to OpenVDB Converter by OmooLab</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="main">
      <div class="form-container">
        <div class="folder-inputs-container">
          <div class="folder-input-container">
            <div class="folder-label">
              <span style="color: #3f7aff">Step1:</span>
              <span style="color: #9397a6">
                Select folder which contains the dicom files.
              </span>
            </div>
            <div class="folder-input">
              <div class="folder-input-btn" id="dicomFolderBtn">
                <svg
                  class="folder-input-btn-icon"
                  width="14"
                  height="14"
                  viewBox="0 0 14 14"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M1.45825 2.33333C1.45825 2.01117 1.71942 1.75 2.04159 1.75H5.54158L6.99992 3.5H11.9583C12.2804 3.5 12.5416 3.76116 12.5416 4.08333V11.6667C12.5416 11.9888 12.2804 12.25 11.9583 12.25H2.04159C1.71942 12.25 1.45825 11.9888 1.45825 11.6667V2.33333Z"
                    stroke="white"
                    stroke-width="1.2"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M12.5416 6.41675H1.45825"
                    stroke="white"
                    stroke-width="1.2"
                    stroke-linejoin="round"
                  />
                </svg>
              </div>
              <input class="folder-input-input" id="dicomPath" type="text" />
            </div>
          </div>
          <div class="folder-input-container">
            <div class="folder-label">
              <span style="color: #3f7aff">Step2(Optional):</span>
              <span style="color: #9397a6">
                Select output folder / edit meta info.
              </span>
            </div>
            <div class="folder-input">
              <div class="folder-input-btn" id="outputFolderBtn">
                <svg
                  class="folder-input-btn-icon"
                  width="14"
                  height="14"
                  viewBox="0 0 14 14"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M1.45825 2.33333C1.45825 2.01117 1.71942 1.75 2.04159 1.75H5.54158L6.99992 3.5H11.9583C12.2804 3.5 12.5416 3.76116 12.5416 4.08333V11.6667C12.5416 11.9888 12.2804 12.25 11.9583 12.25H2.04159C1.71942 12.25 1.45825 11.9888 1.45825 11.6667V2.33333Z"
                    stroke="white"
                    stroke-width="1.2"
                    stroke-linejoin="round"
                  />
                  <path
                    d="M12.5416 6.41675H1.45825"
                    stroke="white"
                    stroke-width="1.2"
                    stroke-linejoin="round"
                  />
                </svg>
              </div>
              <input class="folder-input-input" id="outputPath" type="text" />
            </div>
          </div>
        </div>
        <div class="meta-tables-container">
          <table class="meta-table">
            <tbody>
              <th colspan="4" class="meta-table-header">Input Meta</th>
              <tr>
                <th>Min</th>
                <td colspan="3">
                  <input type="number" maxlength="10" readonly id="inputMin" />
                </td>
              </tr>
              <tr>
                <th>Max</th>
                <td colspan="3">
                  <input type="number" maxlength="10" readonly id="inputMax" />
                </td>
              </tr>
              <tr>
                <th>Spacing</th>
                <td>
                  <input
                    type="number"
                    maxlength="10"
                    readonly
                    id="inputSpacingX"
                  />
                </td>
                <td>
                  <input
                    type="number"
                    maxlength="10"
                    readonly
                    id="inputSpacingY"
                  />
                </td>
                <td>
                  <input
                    type="number"
                    maxlength="10"
                    readonly
                    id="inputSpacingZ"
                  />
                </td>
              </tr>
              <tr>
                <th>Size</th>
                <td>
                  <input
                    type="number"
                    maxlength="10"
                    readonly
                    id="inputSizeX"
                  />
                </td>
                <td>
                  <input
                    type="number"
                    maxlength="10"
                    readonly
                    id="inputSizeY"
                  />
                </td>
                <td>
                  <input
                    type="number"
                    maxlength="10"
                    readonly
                    id="inputSizeZ"
                  />
                </td>
              </tr>
            </tbody>
          </table>
          <div class="arrow-containter">
            <svg
              class="arrow"
              width="20"
              height="44"
              viewBox="0 0 20 44"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                opacity="0.4"
                d="M19.0989 20.7994C19.6328 21.5108 19.6328 22.4892 19.0989 23.2006L4.09957 43.1849C2.94603 44.7218 0.5 43.906 0.5 41.9843L0.500001 2.01568C0.500002 0.0940162 2.94603 -0.721804 4.09958 0.815118L19.0989 20.7994Z"
                fill="#3F7AFF"
              />
            </svg>
          </div>
          <table class="meta-table output">
            <tbody>
              <th colspan="4" class="meta-table-header">Output Meta</th>
              <tr>
                <th>Min</th>
                <td colspan="3">
                  <input type="number" maxlength="10" id="outputMin" />
                </td>
              </tr>
              <tr>
                <th>Max</th>
                <td colspan="3">
                  <input type="number" maxlength="10" id="outputMax" />
                </td>
              </tr>
              <tr>
                <th>Spacing</th>
                <td>
                  <input type="number" maxlength="10" id="outputSpacingX" />
                </td>
                <td>
                  <input type="number" maxlength="10" id="outputSpacingY" />
                </td>
                <td>
                  <input type="number" maxlength="10" id="outputSpacingZ" />
                </td>
              </tr>
              <tr>
                <th>Size</th>
                <td><input type="number" maxlength="10" id="outputSizeX" /></td>
                <td><input type="number" maxlength="10" id="outputSizeY" /></td>
                <td><input type="number" maxlength="10" id="outputSizeZ" /></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="convert-btn" id="convert">
        <div class="convert-progress" id="progress"></div>
        <div class="convert-btn-text" id="state">Step3: CONVERT</div>
      </div>
      <div class="banner-container"></div>
    </div>
  </body>
  <script type="text/javascript">
    const thisWindow = Window.this;

    const empty = {
      min: "",
      max: "",
      spacing: ["", "", ""],
      size: ["", "", ""],
    };

    function fillMetaInfo() {
      document.getElementById("inputMin").value = inputMeta["min"];
      document.getElementById("inputMax").value = inputMeta["max"];
      document.getElementById("inputSizeX").value = inputMeta["size"][0];
      document.getElementById("inputSizeY").value = inputMeta["size"][1];
      document.getElementById("inputSizeZ").value = inputMeta["size"][2];
      document.getElementById("inputSpacingX").value = inputMeta["spacing"][0];
      document.getElementById("inputSpacingY").value = inputMeta["spacing"][1];
      document.getElementById("inputSpacingZ").value = inputMeta["spacing"][2];
      document.getElementById("outputMin").value = outputMeta["min"];
      document.getElementById("outputMax").value = outputMeta["max"];
      document.getElementById("outputSizeX").value = outputMeta["size"][0];
      document.getElementById("outputSizeY").value = outputMeta["size"][1];
      document.getElementById("outputSizeZ").value = outputMeta["size"][2];
      document.getElementById("outputSpacingX").value =
        outputMeta["spacing"][0];
      document.getElementById("outputSpacingY").value =
        outputMeta["spacing"][1];
      document.getElementById("outputSpacingZ").value =
        outputMeta["spacing"][2];
    }

    document.ready = function () {
      thisWindow.isResizable = false;
      thisWindow.isMaximizable = false;
      thisWindow.move(400, 400, 715, 577);
      document.getElementById("convert").disabled = true;
      globalThis.inputMeta = empty;
      globalThis.outputMeta = empty;
      fillMetaInfo();
    };

    document.getElementById("dicomPath").onblur = (event) => {
      globalThis.dicomPath = event.target.value;
      if (globalThis.dicomPath != "") getMetaInfo();
    };

    document.getElementById("outputPath").onblur = (event) => {
      globalThis.outputPath = event.target.value;
    };

    document.getElementById("outputMin").onblur = (event) => {
      const outputMeta = globalThis.outputMeta;
      outputMeta["min"] = event.target.value || 0;
      globalThis.outputMeta = outputMeta;
      document.getElementById("outputMin").value = globalThis.outputMeta["min"];
    };

    document.getElementById("outputMax").onblur = (event) => {
      const outputMeta = globalThis.outputMeta;
      outputMeta["max"] = event.target.value || 0;
      globalThis.outputMeta = outputMeta;
      document.getElementById("outputMax").value = globalThis.outputMeta["max"];
    };

    document.getElementById("outputSpacingX").onblur = (event) => {
      const outputMeta = globalThis.outputMeta;
      const inputSpacingX = globalThis.inputMeta["spacing"][0];
      const inputSizeX = globalThis.inputMeta["size"][0];
      const outputSpacingX = event.target.value || 0;
      const outputSizeX =
        Math.round(((inputSpacingX * inputSizeX) / outputSpacingX) * 1e1) / 1e1;

      // update global var
      outputMeta["spacing"][0] = outputSpacingX;
      outputMeta["size"][0] = outputSizeX;
      globalThis.outputMeta = outputMeta;

      // update ui
      document.getElementById("outputSpacingX").value = outputSpacingX;
      document.getElementById("outputSizeX").value = outputSizeX;
    };

    document.getElementById("outputSpacingY").onblur = (event) => {
      const outputMeta = globalThis.outputMeta;
      const inputSpacingY = globalThis.inputMeta["spacing"][1];
      const inputSizeY = globalThis.inputMeta["size"][1];
      const outputSpacingY = event.target.value || 0;
      const outputSizeY =
        Math.round(((inputSpacingY * inputSizeY) / outputSpacingY) * 1e1) / 1e1;

      // update global var
      outputMeta["spacing"][1] = outputSpacingY;
      outputMeta["size"][1] = outputSizeY;
      globalThis.outputMeta = outputMeta;

      // update ui
      document.getElementById("outputSpacingY").value = outputSpacingY;
      document.getElementById("outputSizeY").value = outputSizeY;
    };

    document.getElementById("outputSpacingZ").onblur = (event) => {
      const outputMeta = globalThis.outputMeta;
      const inputSpacingZ = globalThis.inputMeta["spacing"][2];
      const inputSizeZ = globalThis.inputMeta["size"][2];
      const outputSpacingZ = event.target.value || 0;
      const outputSizeZ =
        Math.round(((inputSpacingZ * inputSizeZ) / outputSpacingZ) * 1e1) / 1e1;

      // update global var
      outputMeta["spacing"][2] = outputSpacingZ;
      outputMeta["size"][2] = outputSizeZ;
      globalThis.outputMeta = outputMeta;

      // update ui
      document.getElementById("outputSpacingZ").value = outputSpacingZ;
      document.getElementById("outputSizeZ").value = outputSizeZ;
    };

    document.getElementById("outputSizeX").onblur = (event) => {
      const outputMeta = globalThis.outputMeta;
      const inputSpacingX = globalThis.inputMeta["spacing"][0];
      const inputSizeX = globalThis.inputMeta["size"][0];
      const outputSizeX = event.target.value || 0;
      const outputSpacingX =
        Math.round(((inputSpacingX * inputSizeX) / outputSizeX) * 1e2) / 1e2;

      // update global var
      outputMeta["spacing"][0] = outputSpacingX;
      outputMeta["size"][0] = outputSizeX;
      globalThis.outputMeta = outputMeta;

      // update ui
      document.getElementById("outputSpacingX").value = outputSpacingX;
      document.getElementById("outputSizeX").value = outputSizeX;
    };

    document.getElementById("outputSizeY").onblur = (event) => {
      const outputMeta = globalThis.outputMeta;
      const inputSpacingY = globalThis.inputMeta["spacing"][1];
      const inputSizeY = globalThis.inputMeta["size"][1];
      const outputSizeY = event.target.value || 0;
      const outputSpacingY =
        Math.round(((inputSpacingY * inputSizeY) / outputSizeY) * 1e2) / 1e2;

      // update global var
      outputMeta["spacing"][1] = outputSpacingY;
      outputMeta["size"][1] = outputSizeY;
      globalThis.outputMeta = outputMeta;

      // update ui
      document.getElementById("outputSpacingY").value = outputSpacingY;
      document.getElementById("outputSizeY").value = outputSizeY;
    };

    document.getElementById("outputSizeZ").onblur = (event) => {
      const outputMeta = globalThis.outputMeta;
      const inputSpacingZ = globalThis.inputMeta["spacing"][2];
      const inputSizeZ = globalThis.inputMeta["size"][2];
      const outputSizeZ = event.target.value || 0;
      const outputSpacingZ =
        Math.round(((inputSpacingZ * inputSizeZ) / outputSizeZ) * 1e2) / 1e2;

      // update global var
      outputMeta["spacing"][2] = outputSpacingZ;
      outputMeta["size"][2] = outputSizeZ;
      globalThis.outputMeta = outputMeta;

      // update ui
      document.getElementById("outputSpacingZ").value = outputSpacingZ;
      document.getElementById("outputSizeZ").value = outputSizeZ;
    };

    document.getElementById("outputPath").onchange = (event) => {
      globalThis.outputPath = event.target.value || 0;
    };

    document.getElementById("outputPath").onchange = (event) => {
      globalThis.outputPath = event.target.value || 0;
    };

    function getMetaInfo() {
      document.getElementById("state").innerText = "Searching...";
      document.getElementById("convert").disabled = true;

      function callback(res) {
        switch (res["state"]) {
          case 0:
            const inputMeta = {
              min: res["data"]["input_min"],
              max: res["data"]["input_max"],
              spacing: res["data"]["input_spacing"],
              size: res["data"]["input_size"],
            };

            const outputMeta = {
              min: 0,
              max: -res["data"]["input_min"] + res["data"]["input_max"],
              spacing: [1, 1, 1],
              size: res["data"]["input_size"].map((dim, index) => {
                const size = dim * res["data"]["input_spacing"][index];
                return Math.round(size * 1e1) / 1e1;
              }),
            };

            globalThis.inputMeta = inputMeta;
            globalThis.outputMeta = outputMeta;
            fillMetaInfo();

            document.getElementById("state").innerText = "Step3: CONVERT";
            document.getElementById("convert").disabled = false;
            break;
          case 1:
            globalThis.inputMeta = empty;
            globalThis.outputMeta = empty;
            fillMetaInfo();
            document.getElementById("state").innerText = res["data"];
            break;
          case 2:
            globalThis.inputMeta = empty;
            globalThis.outputMeta = empty;
            fillMetaInfo();
            document.getElementById("state").innerText = "No Dicoms Found";
            break;
          default:
            break;
        }
      }
      thisWindow.appWindow.getMetaInfo(globalThis.dicomPath, callback);
    }

    document.getElementById("dicomFolderBtn").onclick = function () {
      let dicomPath = thisWindow.selectFolder({
        mode: "open",
      });

      if (dicomPath) {
        globalThis.dicomPath = decodeURIComponent(
          dicomPath.replace("file://", "")
        );
        document.getElementById("dicomPath").innerText = globalThis.dicomPath;
        if (globalThis.outputPath === undefined) {
          const path_arr = globalThis.dicomPath.split("/");
          path_arr.pop();
          globalThis.outputPath = path_arr.join("/");
          document.getElementById("outputPath").innerText =
            globalThis.outputPath;
        }
      }

      getMetaInfo();
    };

    document.getElementById("outputFolderBtn").onclick = function () {
      let outputPath = thisWindow.selectFolder({
        mode: "open",
      });

      if (outputPath) {
        globalThis.outputPath = decodeURIComponent(
          outputPath.replace("file://", "")
        );
        document.getElementById("outputPath").innerText = globalThis.outputPath;
      }
    };

    document.getElementById("convert").onclick = function () {
      // if (
      //   (globalThis.dicomPath === undefined) |
      //   (globalThis.outputPath === undefined)
      // ) {
      //   thisWindow.modal(
      //     <alert>
      //       Dicom or output folder is not defined.
      //       <br />
      //       Please choose folder path first.
      //     </alert>
      //   );
      //   return false;
      // }

      document.getElementById("state").innerText = "Started...";
      document.getElementById("progress").style.visibility = "visible";
      document.getElementById("progress").style.width = 0;
      document.getElementById("convert").disabled = true;

      function callback(res) {
        switch (res["state"]) {
          case 0:
            thisWindow.modal(<info>Convertion Completed</info>);
            document.getElementById("progress").style.visibility = "hidden";
            document.getElementById("state").innerText = "Step3: CONVERT";
            document.getElementById("convert").disabled = false;
            break;
          case 1:
            document.getElementById("progress").style.visibility = "hidden";
            document.getElementById("state").innerText = res["data"];
            document.getElementById("convert").disabled = false;
            break;
          case 2:
            document.getElementById("progress").style.width = res["data"];
            document.getElementById("state").innerText = res["data"];
          default:
            break;
        }
      }

      // thisWindow.modal(
      //   <info>
      //     Min: {globalThis.outputMeta["min"]}
      //     <br />
      //     Max: {globalThis.outputMeta["max"]}
      //     <br />
      //     Spacing:
      //     <br />
      //     {globalThis.outputMeta["spacing"][0]},<br />
      //     {globalThis.outputMeta["spacing"][1]},<br />
      //     {globalThis.outputMeta["spacing"][2]}
      //     <br />
      //     Size:
      //     <br />
      //     {globalThis.outputMeta["size"][0]},<br />
      //     {globalThis.outputMeta["size"][1]},<br />
      //     {globalThis.outputMeta["size"][2]}
      //     <br />
      //   </info>
      // );

      thisWindow.appWindow.convertDICOM(
        globalThis.dicomPath,
        globalThis.outputPath,
        globalThis.outputMeta,
        callback
      );
    };
  </script>
</html>
